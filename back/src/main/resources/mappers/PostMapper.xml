<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gardener.post.PostMapper">
    <sql id="postColumns">
        id
        ,member_id, main_title, sub_title, content, main_title_img, category, post_public, favorite, create_post
    </sql>

    <insert id="insertPost" parameterType="Post">
        insert into post(<include refid="postColumns"></include>)
        values(post_seq.nextval, #{memberId}, #{mainTitle}, #{subTitle}, #{content}, #{mainTitleImg},
        #{category}, 0, 0, systimestamp )
    </insert>

    <!--    동적쿼리로 처리-->
    <insert id="insertImgs" parameterType="map">
        INSERT INTO imgs (id, img1, img2, img3, img4, img5)
        <choose>
            <when test="img4 != null ">
                VALUES (#{id}, #{img0}, #{img1}, #{img2}, #{img3}, #{img4})
            </when>
            <when test="img3 != null">
                VALUES (#{id}, #{img0}, #{img1}, #{img2}, #{img3}, null)
            </when>
            <when test="img2 != null">
                VALUES (#{id}, #{img0}, #{img1}, #{img2}, null, null)
            </when>
            <when test="img1 != null">
                VALUES (#{id}, #{img0}, #{img1}, null, null, null)
            </when>
            <when test="img0 != null">
                VALUES (#{id}, #{img0}, null, null, null, null)
            </when>
        </choose>
        <selectKey keyProperty="id" resultType="int" order="BEFORE">
            select post_seq.currval from dual
        </selectKey>
    </insert>

    <resultMap id="joinMap" type="Post" autoMapping="true">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="mainTitle" column="main_title"/>
        <result property="subTitle" column="sub_title"/>
        <result property="content" column="content"/>
        <result property="mainTitleImg" column="main_title_img"/>
        <result property="category" column="category"/>
        <result property="postPublic" column="post_public"/>
        <result property="favorite" column="favorite"/>
        <result property="createPost" column="create_post"/>
        <association property="member" javaType="Member" autoMapping="true"/>
    </resultMap>

    <select id="selectPost" parameterType="int" resultMap="joinMap">
        SELECT m.name,
               m.intro,
               m.profile,
               p.*
        FROM post p
                 JOIN MEMBER m ON p.member_id = m.id
        WHERE p.id = #{id}
    </select>

    <select id="selectAllPosts" resultMap="joinMap">
        SELECT m.name,
               m.intro,
               m.profile,
               p.*
        from post p,
             member m
        WHERE (p.member_id = m.id)
        ORDER BY p.id desc
    </select>

</mapper>


